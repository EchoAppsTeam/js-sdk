<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">(function(jQuery) {
&quot;use strict&quot;;

var $ = jQuery;

<span id='Echo-StreamServer-Controls-Counter-method-constructor'><span id='Echo-StreamServer-Controls-Counter'>/**
</span></span> * @class Echo.StreamServer.Controls.Counter
 * Echo Counter class which encapsulates interaction with the
 * &lt;a href=&quot;http://wiki.aboutecho.com/w/page/27888212/API-method-count&quot; target=&quot;_blank&quot;&gt;Echo Count API&lt;/a&gt;
 * and provides a simple live updating number.
 *
 * 	new Echo.StreamServer.Controls.Counter({
 * 		&quot;target&quot;: document.getElementById(&quot;echo-counter&quot;),
 * 		&quot;appkey&quot;: &quot;test.aboutecho.com&quot;,
 * 		&quot;query&quot; : &quot;childrenof:http://example.com/test/*&quot;
 * 	});
 *
 * @extends Echo.Control
 *
 * @constructor
 * Counter constructor initializing Echo.StreamServer.Controls.Counter class
 *
 * @param {Object} config
 * Configuration options
 */
var counter = Echo.Control.manifest(&quot;Echo.StreamServer.Controls.Counter&quot;);

if (Echo.Control.isDefined(counter)) return;

counter.init = function() {
	if (!this.checkAppKey()) return;

	this.request = this._getRequestObject();
	if ($.isEmptyObject(this.get(&quot;data&quot;))) {
		this.request.send();
	} else {
		this.render();
		this.ready();
		this.request.send({
			&quot;skipInitialRequest&quot;: true
		});
	}
};

counter.config = {
<span id='Echo-StreamServer-Controls-Counter-cfg-query'>	/**
</span>	 * @cfg {String} query
	 * Specifies the search query to generate the necessary data set.
	 * It must be constructed according to the
	 * &lt;a href=&quot;http://wiki.aboutecho.com/w/page/23491639/API-method-search&quot; target=&quot;_blank&quot;&gt;&quot;search&quot; API&lt;/a&gt;
	 * method specification.
	 *
	 * 	new Echo.StreamServer.Controls.Counter({
	 * 		&quot;target&quot;: document.getElementById(&quot;echo-counter&quot;),
	 * 		&quot;appkey&quot;: &quot;test.aboutecho.com&quot;,
	 * 		&quot;query&quot; : &quot;childrenof:http://example.com/test/*&quot;
	 * 	});
	 */
<span id='Echo-StreamServer-Controls-Counter-cfg-data'>	/**
</span>	 * @cfg {Object} data
	 * Specifies predefined items count which should be displayed by the application.
	 * Counter control works with the data format used by the &quot;count&quot; API endpoint.
	 * More information about the data format can be found
	 * &lt;a href=&quot;http://wiki.aboutecho.com/API-method-count#ResponseFormat&quot; target=&quot;_blank&quot;&gt;here&lt;/a&gt;.
	 *
	 * 	new Echo.Counter({
	 * 		...
	 * 		&quot;data&quot;: {&quot;count&quot;: 100},
	 * 		...
	 * 	});
	 */
	&quot;data&quot;: undefined,
<span id='Echo-StreamServer-Controls-Counter-cfg-liveUpdates'>	/**
</span>	 * @cfg {Object} liveUpdates
	 * Defines configurations for liveUpdates.
	 *
	 * @cfg {Boolean} liveUpdates.enabled
	 * Parameter to enable/disable receiving live updates by control.
	 *
	 * @cfg {Number} liveUpdates.timeout
	 * Specifies the timeout between live updates requests (in seconds).
	 */
	&quot;liveUpdates&quot;: {
		&quot;enabled&quot;: true,
		&quot;timeout&quot;: 10
	},
<span id='Echo-StreamServer-Controls-Counter-cfg-infoMessages'>	/**
</span>	 * @cfg {String} infoMessages 
	 * Customizes the look and feel of info messages, for example &quot;loading&quot; and &quot;error&quot;.
	 */
	&quot;infoMessages&quot;: {&quot;layout&quot;: &quot;compact&quot;}
};

counter.templates.main = &quot;&lt;span&gt;{data:count}&lt;/span&gt;&quot;;

counter.methods._getRequestObject = function(overrides) {
	return Echo.StreamServer.API.request(
		$.extend(true, {
			&quot;endpoint&quot;: &quot;count&quot;,
			&quot;data&quot;: {
				&quot;q&quot;: this.config.get(&quot;query&quot;),
				&quot;appkey&quot;: this.config.get(&quot;appkey&quot;)
			},
			&quot;liveUpdatesTimeout&quot;: this.config.get(&quot;liveUpdates.timeout&quot;),
			&quot;recurring&quot;: this.config.get(&quot;liveUpdates.enabled&quot;),
			&quot;secure&quot;: this.config.get(&quot;useSecureAPI&quot;),
			&quot;onError&quot;: $.proxy(this._error, this),
			&quot;onData&quot;: $.proxy(this._handleResponse, this)
		}, overrides)
	);
};

counter.methods._maybeUpdate = function(data) {
	if ($.isEmptyObject(this.data) || this.data.count != data.count) {
		this.events.publish({
			&quot;topic&quot;: &quot;onUpdate&quot;,
			&quot;data&quot;: {
				&quot;data&quot;: data,
				&quot;query&quot;: this.config.get(&quot;query&quot;),
				&quot;target&quot;: this.config.get(&quot;target&quot;).get(0)
			}
		});
		this.set(&quot;data&quot;, data);
		this.render();
	}
};

counter.methods._handleResponse = function(data, options) {
	this._maybeUpdate(data);
	if (options.requestType === &quot;initial&quot;) {
		this.ready();
	}
};

counter.methods._error = function(data, options) {
	this.events.publish({
		&quot;topic&quot;: &quot;onError&quot;,
		&quot;data&quot;: {
			&quot;data&quot;: data,
			&quot;query&quot;: this.config.get(&quot;query&quot;),
			&quot;target&quot;: this.config.get(&quot;target&quot;).get(0)
		}
	});
	if (data.errorCode === &quot;more_than&quot;) {
		this.set(&quot;data.count&quot;, data.errorMessage + &quot;+&quot;);
		this.render();
	} else {
		if (typeof options.critical === &quot;undefined&quot; || options.critical || options.requestType === &quot;initial&quot;) {
			this.showMessage({&quot;type&quot;: &quot;error&quot;, &quot;data&quot;: data, &quot;message&quot;: data.errorMessage});
		}
	}
	this.ready();
};

Echo.Control.create(counter);

})(Echo.jQuery);
</pre>
</body>
</html>
