<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">(function(jQuery) {
&quot;use strict&quot;;

var $ = jQuery;

if (Echo.Utils.isComponentDefined(&quot;Echo.Events&quot;)) return;

<span id='Echo-Events'>/**
</span> * @class Echo.Events
 * Library for exchanging messages between the components on the page. It also
 * provides the external interface for users to subscribe to certain events
 * (like &quot;app was rendered&quot;, &quot;user logged in&quot;, etc).
 *
 * The contexts used in this library are complex identifiers constructed using the following rules:
 *     &amp;lt;contextId&gt; :: &quot;&amp;lt;id&gt;&quot; or &quot;&amp;lt;parentContextID&gt;/&amp;lt;id&gt;&quot;, where
 *     &amp;lt;id&gt; :: some unique identifier assigned to component
 *     &amp;lt;parentContextID&gt; :: &quot;&amp;lt;contextID&gt;&quot;
 *
 * Example:
 *
 * 	// Subscribe to the event.
 * 	Echo.Events.subscribe({
 * 		&quot;topic&quot;: &quot;Echo.UserSession.onInvalidate&quot;,
 * 		&quot;context&quot;: &quot;global&quot;,
 * 		&quot;handler&quot;: control.refresh
 * 	});
 *
 * 	// And then publish event:
 * 	Echo.Events.publish({
 * 		&quot;topic&quot;: &quot;Echo.UserSession.onInvalidate&quot;,
 * 		&quot;data&quot;: user.is(&quot;logged&quot;) ? user.data : {}
 * 	});
 *
 * @package environment.pack.js
 */
Echo.Events = {};

<span id='Echo-Events-static-method-subscribe'>/**
</span> * @static
 * Function allowing to subscribe to an event with a specific callback function
 * and topic.
 *
 * @param {Object} params
 * Configuration parameters object with the following fields:
 *
 * @param {String} params.topic
 * Event name.
 *
 * @param {String} [params.context]
 * Unique identifier for inter-component communication.
 *
 * @param {Boolean} [params.once=false]
 * Specifies that provided handler should be executed exactly once (handler will
 * be unsubscribed right before its execution).
 *
 * @param {Function} params.handler
 * Callback function which will be called when event is published
 *
 * @param {String} params.handler.topic
 * Event name (same as params.topic).
 *
 * @param {Object} params.handler.data
 * Arbitrary data object passed to the {@link #publish} function.
 *
 * @return {String}
 * Unique identifier for the current subscription which can be used for unsubscribing.
 */
Echo.Events.subscribe = function(params) {
	var handlerId = Echo.Utils.getUniqueString();
	var context = _initContext(params.topic, params.context);
	if (params.once) {
		var handler = params.handler;
		params.handler = function() {
			Echo.Events.unsubscribe({&quot;handlerId&quot;: handlerId});
			handler.apply(this, arguments);
		};
	}
	_executeForDeepestContext(params.topic, context, function(obj, lastContext) {
		obj[lastContext].handlers.push({
			&quot;id&quot;: handlerId,
			&quot;handler&quot;: params.handler
		});
	});
	_dataByHandlerId[handlerId] = {
		&quot;context&quot;: context,
		&quot;topic&quot;: params.topic
	};
	return handlerId;
};

<span id='Echo-Events-static-method-unsubscribe'>/**
</span> * @static
 * Function allowing to unsubscribe from an event.
 *
 * @param {Object} params
 * Configuration parameters object with the following fields:
 *
 * @param {String} params.topic
 * Event name.
 *
 * @param {String} [params.context]
 * Unique identifier for inter-component communication.
 *
 * @param {String} params.handlerId
 * Unique identifier from the {@link #subscribe} function.
 *
 * @return {Boolean}
 * Unsubscription status.
 */
Echo.Events.unsubscribe = function(params) {
	var unsubscribed = false;
	if (params.handlerId) {
		if (_dataByHandlerId[params.handlerId]) {
			params.topic = _dataByHandlerId[params.handlerId].topic;
			params.context = _dataByHandlerId[params.handlerId].context;
		} else {
			// trying to unsubsribe from previously unsubscribed handler
			return false;
		}
	} else {
		params.context = _initContext(params.topic, params.context);
	}
	if (params.handlerId || params.topic) {
		var obj = _executeForDeepestContext(params.topic, params.context, function(obj, lastContext) {
			if (params.handlerId) {
				$.each(obj[lastContext].handlers, function(i, data) {
					if (data.id === params.handlerId) {
						obj[lastContext].handlers.splice(i, 1);
						delete _dataByHandlerId[data.id];
						unsubscribed = true;
						return false;
					}
				});
			} else {
				$.each(obj[lastContext].handlers, function(i, data) {
					delete _dataByHandlerId[data.id];
				});
				delete obj[lastContext];
				unsubscribed = true;
			}
		});
	} else {
		$.each(Echo.Events._subscriptions, function(topic, data) {
			_executeForDeepestContext(topic, params.context, function(obj, lastContext) {
				$.each(obj[lastContext].handlers, function(i, data) {
					delete _dataByHandlerId[data.id];
				});
				delete obj[lastContext];
				unsubscribed = true;
			});
		});
	}
	return unsubscribed;
};

<span id='Echo-Events-static-method-publish'>/**
</span> * @static
 * Function allowing to publish an event providing arbitrary data.
 *
 * @param {Object} params
 * Configuration parameters object with the following fields:
 *
 * @param {String} params.topic
 *  Event name.
 *
 * @param {String} [params.context]
 * Unique identifier for inter-component communication.
 *
 * @param {Object} [params.data]
 * Some data object.
 *
 * @param {Boolean} [params.bubble=true]
 * Indicates whether a given event should be propagated into the parent contexts.
 *
 * @param {Boolean} [params.propagation=true]
 * Indicates whether a given event should be propagated into the child contexts
 * AND executed for the current context.
 *
 * @param {Boolean} [params.global=true]
 * Specifies whether the event should also be published to the &quot;global&quot; context or not.
 */
Echo.Events.publish = function(params) {
	params = $.extend({
		&quot;bubble&quot;: true,
		&quot;propagation&quot;: true,
		&quot;global&quot;: true
	}, params);
	delete _lastHandlerResult[params.topic];
	params.context = _initContext(params.topic, params.context);
	_executeForDeepestContext(params.topic, params.context, function(obj, lastContext, restContexts) {
		_callHandlers(obj[lastContext], params, restContexts);
	});
	if (params.global &amp;&amp; params.context !== &quot;global&quot;) {
		params.context = &quot;global&quot;;
		Echo.Events.publish(params);
	}
};

<span id='Echo-Events-static-method-newContextId'>/**
</span> * @static
 * Generates a string which represents new unique context ID to be used for subscriptions.
 *
 * @param {String} [parentContextId]
 * Optional parameter which specifies the parent object context ID.
 * If this parameter is defined, the nested context ID is generated.
 *
 * @return {String}
 * Unique context identifier.
 */
Echo.Events.newContextId = function(parentContextId) {
	return (parentContextId ? parentContextId + &quot;/&quot; : &quot;&quot;) + Echo.Utils.getUniqueString();
};

var _lastHandlerResult = {}, _dataByHandlerId = {};
Echo.Events._subscriptions = {};

var _initContext = function(topic, context) {
	context = context || &quot;global&quot;;
	if (topic) {
		var obj = Echo.Events._subscriptions[topic] = Echo.Events._subscriptions[topic] || {};
		$.each(context.split(&quot;/&quot;), function(i, part) {
			if (!obj[part]) {
				obj[part] = {
					&quot;contexts&quot;: {},
					&quot;handlers&quot;: []
				};
			}
			obj = obj[part].contexts;
		});
	}
	return context;
};

var _executeForDeepestContext = function(topic, context, callback) {
	var parts = context.split(&quot;/&quot;);
	var lastContext = parts.pop();
	var obj = Echo.Events._subscriptions[topic];
	$.each(parts, function(i, part) {
		obj = obj[part].contexts;
	});
	if (obj[lastContext]) {
		callback(obj, lastContext, parts);
	}
};

var _shouldStopEvent = function(stopperType, topic) {
	var stoppers = _lastHandlerResult[topic] &amp;&amp; _lastHandlerResult[topic].stop;
	if (!stoppers) {
		return false;
	}
	return stopperType === &quot;bubble&quot;
		? ~$.inArray(&quot;bubble&quot;, stoppers)
		: ~$.inArray(&quot;propagation&quot;, stoppers) || ~$.inArray(stopperType, stoppers);
};

var _callHandlers = function(obj, params, restContexts) {
	// use copy of handler list so that inner unsubscribe actions couldn&#39;t mess it up
	var _params, handlers = (obj.handlers || []).slice(0);
	$.each(handlers, function(i, data) {
		_lastHandlerResult[params.topic] = data.handler(params.topic, params.data);
		if (_shouldStopEvent(&quot;propagation.siblings&quot;, params.topic)) {
			return false;
		}
	});
	if (params.bubble &amp;&amp; restContexts.length &amp;&amp; !_shouldStopEvent(&quot;bubble&quot;, params.topic)) {
		// copy incoming parameters object so that we can manipulate it freely
		_params = $.extend({}, params);
		_params.context = restContexts.join(&quot;/&quot;);
		_params.global = false;
		_params.propagation = false;
		Echo.Events.publish(_params);
	}
	if (params.propagation &amp;&amp; !_shouldStopEvent(&quot;propagation.children&quot;, params.topic)) {
		// copy incoming parameters object so that we can manipulate it freely
		_params = $.extend({}, params);
		_params.global = false;
		_params.bubble = false;
		$.each(obj.contexts, function(id, context) {
			_callHandlers(context, _params, []);
			if (_shouldStopEvent(&quot;propagation.siblings&quot;, _params.topic)) {
				return false;
			}
		});
	}
};

})(Echo.jQuery);
</pre>
</body>
</html>
