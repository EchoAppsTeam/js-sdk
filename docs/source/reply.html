<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">(function(jQuery) {
&quot;use strict&quot;;

var $ = jQuery;

<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply'>/**
</span> * @class Echo.StreamServer.Controls.Stream.Item.Plugins.Reply
 * Adds extra “Reply” button to each item in the Echo Stream control.
 * Integrates Echo Submit control and provides the ability to submit
 * replies to the posted items.
 *
 * 	new Echo.StreamServer.Controls.Stream({
 * 		&quot;target&quot;: document.getElementById(&quot;echo-stream&quot;),
 * 		&quot;appkey&quot;: &quot;echo.jssdk.demo.aboutecho.com&quot;,
 * 		&quot;plugins&quot;: [{
 * 			&quot;name&quot;: &quot;Reply&quot;
 * 		}]
 * 	});
 *
 * More information regarding the plugins installation can be found
 * in the [“How to initialize Echo components”](#!/guide/how_to_initialize_components-section-initializing-plugins) guide.
 *
 * @extends Echo.Plugin
 *
 * @package streamserver/plugins.pack.js
 * @package streamserver.pack.js
 */
var plugin = Echo.Plugin.manifest(&quot;Reply&quot;, &quot;Echo.StreamServer.Controls.Stream.Item&quot;);

if (Echo.Plugin.isDefined(plugin)) return;

plugin.init = function() {
	var self = this, item = this.component;
	this.extendTemplate(&quot;insertAsLastChild&quot;, &quot;content&quot;, plugin.templates.form);
	var form = Echo.Utils.get(Echo.Variables, this._getSubmitKey());
	$.each(form || {}, function(key, value) {
	    self.set(key, value);
	});
	item.addButtonSpec(&quot;Reply&quot;, this._assembleButton());
	this.set(&quot;documentClickHandler&quot;, this._getClickHandler());
	$(document).on(&#39;click&#39;, this.get(&quot;documentClickHandler&quot;));
};

plugin.config = {
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-cfg-actionString'>	/**
</span>	 * @cfg {String} actionString
	 * Specifies the hint placed in the empty text area.
	 *
	 * 	new Echo.StreamServer.Controls.Stream({
	 * 		&quot;target&quot;: document.getElementById(&quot;echo-stream&quot;),
	 * 		&quot;appkey&quot;: &quot;echo.jssdk.demo.aboutecho.com&quot;,
	 * 		&quot;plugins&quot;: [{
	 * 			&quot;name&quot;: &quot;Reply&quot;,
	 * 			&quot;actionString&quot;: &quot;Type your comment here...&quot;
	 * 		}]
	 * 	});
	 */
	&quot;actionString&quot;: &quot;Write a reply...&quot;
};

plugin.labels = {
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-echo_label-replyControl'>	/**
</span>	 * @echo_label
	 * Label for the button in the item
	 */
	&quot;replyControl&quot;: &quot;Reply&quot;
};

plugin.dependencies = [{
	&quot;control&quot;: &quot;Echo.StreamServer.Controls.Submit&quot;,
	&quot;url&quot;: &quot;{config:cdnBaseURL.sdk}/streamserver.pack.js&quot;
}];

plugin.events = {
	&quot;Echo.StreamServer.Controls.Stream.Plugins.Reply.onFormExpand&quot;: function(topic, args) {
		var item = this.component;
		var context = item.config.get(&quot;context&quot;);
		if (this.get(&quot;expanded&quot;) &amp;&amp; context &amp;&amp; context !== args.context) {
			this._hideSubmit();
		}
	},
	&quot;Echo.StreamServer.Controls.Submit.onPostComplete&quot;: function(topic, args) {
		this._hideSubmit();
	},
	&quot;Echo.StreamServer.Controls.Stream.Item.onRender&quot;: function(topic, args) {
		if (this.get(&quot;expanded&quot;)) {
			this._showSubmit();
		}
	}
};

<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-echo_template-form'>/**
</span> * @echo_template
 */
plugin.templates.form =
	&#39;&lt;div class=&quot;{plugin.class:replyForm}&quot;&gt;&#39; +
		&#39;&lt;div class=&quot;{plugin.class:submitForm}&quot;&gt;&lt;/div&gt;&#39; +
		&#39;&lt;div class=&quot;{plugin.class:compactForm}&quot;&gt;&#39; +
			&#39;&lt;div class=&quot;{plugin.class:compactContent} {plugin.class:compactBorder}&quot;&gt;&#39; +
				&#39;&lt;input type=&quot;text&quot; class=&quot;{plugin.class:compactField} echo-primaryFont echo-secondaryColor&quot;&gt;&#39; +
			&#39;&lt;/div&gt;&#39; +
		&#39;&lt;/div&gt;&#39; +
	&#39;&lt;/div&gt;&#39;;

<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-echo_renderer-container'>/**
</span> * @echo_renderer
 */
plugin.component.renderers.container = function(element) {
	var item = this.component;
	var threading = item.threading;
	if (this.get(&quot;expanded&quot;)) {
		item.threading = true;
	}
	item.parentRenderer(&quot;container&quot;, arguments);
	item.threading = threading;
	return element;
};

<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-echo_renderer-children'>/**
</span> * @echo_renderer
 */
plugin.component.renderers.children = function(element) {
	var item = this.component;
	// perform reply form rerendering *only* when we have exactly 1 item
	// (the first item is being added or the last one is being deleted)
	if (item.get(&quot;children&quot;).length === 1) {
		var child = item.get(&quot;children&quot;)[0];
		if (child.get(&quot;added&quot;) || child.get(&quot;deleted&quot;)) {
			this._itemCSS(&quot;remove&quot;, item, this.view.get(&quot;compactForm&quot;));
			this.view.render({&quot;name&quot;: &quot;compactForm&quot;});
		}
	}
	return item.parentRenderer(&quot;children&quot;, arguments);
};

<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-echo_renderer-submitForm'>/**
</span> * @echo_renderer
 */
plugin.renderers.submitForm = function(element) {
	element.click(function(event) {
		event.stopPropagation();
	});
	return this.get(&quot;expanded&quot;) ? element.show() : element.empty().hide();
};

<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-echo_renderer-compactForm'>/**
</span> * @echo_renderer
 */
plugin.renderers.compactForm = function(element) {
	var item = this.component;
	var hasChildren = !!item.children.length;
	if (!item.get(&quot;depth&quot;) &amp;&amp; hasChildren &amp;&amp; !this.get(&quot;expanded&quot;) &amp;&amp; !item.get(&quot;children&quot;)[0].get(&quot;deleted&quot;)) {
		this._itemCSS(&quot;add&quot;, item, element);
		return element.show();
	}
	this._itemCSS(&quot;remove&quot;, item, this.view.get(&quot;compactForm&quot;));
	return element.hide();
};

<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-echo_renderer-compactField'>/**
</span> * @echo_renderer
 */
plugin.renderers.compactField = function(element) {
	var plugin = this, item = this.component;
	return element.focus(function() {
		plugin._showSubmit();
	}).val(this.config.get(&quot;actionString&quot;));
};

<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-method-destroy'>/**
</span> * Method to destroy the plugin.
 */
plugin.methods.destroy = function() {
	if (this.get(&quot;submit&quot;)) {
		Echo.Utils.set(Echo.Variables, this._getSubmitKey(), {
			&quot;expanded&quot;: this.get(&quot;expanded&quot;),
			&quot;data&quot;: {
				&quot;object&quot;: this._getSubmitData()
			}
		});
	}
	$(document).off(&#39;click&#39;, this.get(&quot;documentClickHandler&quot;));
};

plugin.methods._submitConfig = function(target) {
	var plugin = this, item = this.component;
	return plugin.config.assemble({
		&quot;target&quot;: target,
		&quot;targetURL&quot;: item.get(&quot;data.object.id&quot;),
		&quot;parent&quot;: item.config.getAsHash(),
		&quot;data&quot;: plugin.get(&quot;data&quot;) || {},
		&quot;targetQuery&quot;: item.config.get(&quot;query&quot;, &quot;&quot;),
		&quot;ready&quot;: function() {
			plugin.set(&quot;submit&quot;, this);
			plugin._expand();
		}
	});
};

plugin.methods._showSubmit = function() {
	var item = this.component;
	var target = this.view.get(&quot;submitForm&quot;);
	this._itemCSS(&quot;add&quot;, item, this.view.get(&quot;submitForm&quot;));
	var submit = this.get(&quot;submit&quot;);
	if (submit) {
		submit.config.set(&quot;target&quot;, target);
		submit.render();
		this._expand();
		return target;
	}
	var config = this._submitConfig(target);
	config.plugins.push({
		&quot;name&quot;: &quot;Reply&quot;,
		&quot;inReplyTo&quot;: item.get(&quot;data&quot;)
	});
	new Echo.StreamServer.Controls.Submit(config);
	return target;
};

plugin.methods._hideSubmit = function() {
	var item = this.component;
	var submit = this.get(&quot;submit&quot;);
	if (submit) {
		submit.set(&quot;data&quot;, undefined);
	}
	this.set(&quot;expanded&quot;, false);
	this._itemCSS(&quot;remove&quot;, item, this.view.get(&quot;submitForm&quot;));
	this.view.get(&quot;submitForm&quot;).empty();
	this.view.render({&quot;name&quot;: &quot;compactForm&quot;});
	item.view.render({&quot;name&quot;: &quot;container&quot;});
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-echo_event-onCollapse'>	/**
</span>	 * @echo_event Echo.StreamServer.Controls.Stream.Item.Plugins.Reply.onCollapse
	 * Triggered when the reply form is closed.
	 */
	this.events.publish({
		&quot;topic&quot;: &quot;onCollapse&quot;
	});
};

plugin.methods._expand = function() {
	var item = this.component;
	this.set(&quot;expanded&quot;, true);
	this.view.render({&quot;name&quot;: &quot;submitForm&quot;});
	this.view.render({&quot;name&quot;: &quot;compactForm&quot;});
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Reply-echo_event-onExpand'>	/**
</span>	 * @echo_event Echo.StreamServer.Controls.Stream.Item.Plugins.Reply.onExpand
	 * Triggered when the reply form is expanded.
	 */
	this.events.publish({
		&quot;topic&quot;: &quot;onExpand&quot;,
		&quot;data&quot;: {
			&quot;context&quot;: item.config.get(&quot;context&quot;)
		}
	});
	item.view.render({&quot;name&quot;: &quot;container&quot;});
};

plugin.methods._getClickHandler = function() {
	var plugin = this;
	return function() {
	    var submit = plugin.get(&quot;submit&quot;);
	    if (plugin.get(&quot;expanded&quot;) &amp;&amp; submit &amp;&amp; !submit.view.get(&quot;text&quot;).val()) {
		    plugin._hideSubmit();
	    }
	};
};

plugin.methods._assembleButton = function() {
	var plugin = this, item = this.component;
	var callback = function() {
		plugin._showSubmit();
	};
	return function() {
		var item = this;
		return {
			&quot;name&quot;: &quot;Reply&quot;,
			&quot;label&quot;: plugin.labels.get(&quot;replyControl&quot;),
			&quot;visible&quot;: item.get(&quot;depth&quot;) &lt; item.config.get(&quot;parent.children.maxDepth&quot;),
			&quot;callback&quot;: callback
		};
	};
};

plugin.methods._itemCSS = function(action, item, element) {
	$.each([&quot;container&quot;, &quot;container-child&quot;, &quot;depth-&quot; + (item.get(&quot;depth&quot;) + 1)], function(i, css) {
		element[action + &quot;Class&quot;](item.get(&quot;cssPrefix&quot;) + css);
	});
	element[action + &quot;Class&quot;](&#39;echo-trinaryBackgroundColor&#39;);
};

plugin.methods._getSubmitKey = function() {
	var item = this.component;
	var applicationContext = item.config.get(&quot;context&quot;).split(&quot;/&quot;)[0];
	return &quot;forms.&quot; + item.data.unique + &quot;-&quot; + applicationContext;
};

plugin.methods._getSubmitData = function() {
	var data = {};
	var submit = this.get(&quot;submit&quot;);
	data[&quot;content&quot;] = submit.view.get(&quot;text&quot;).val();
	$.map([&quot;tags&quot;, &quot;markers&quot;], function(field) {
		var elements = submit.view.get(field).val().split(&quot;, &quot;);
		data[field] = elements || [];
	});
	return data;
};

plugin.css = 
	&quot;.{plugin.class:compactContent} { padding: 5px 5px 5px 6px; background-color: #fff; }&quot; +
	&quot;.{plugin.class:compactBorder} { border: 1px solid #d2d2d2; }&quot; +
	&quot;.{plugin.class:compactContent} input.{plugin.class:compactField}[type=&#39;text&#39;].echo-secondaryColor { color: #C6C6C6 }&quot; +
	&quot;.{plugin.class:compactContent} input.{plugin.class:compactField}[type=&#39;text&#39;].echo-primaryFont { font-size: 12px; line-height: 16px; }&quot; +
	&quot;.{plugin.class:compactContent} input.{plugin.class:compactField}[type=&#39;text&#39;] { width: 100%; height: 16px; border: none; margin: 0px; padding: 0px; box-shadow: none; vertical-align: middle; }&quot; +
	&quot;.{plugin.class:compactContent} input.{plugin.class:compactField}[type=&#39;text&#39;]:focus { outline: 0; box-shadow: none; }&quot;;

Echo.Plugin.create(plugin);

})(Echo.jQuery);

(function(jQuery) {
&quot;use strict&quot;;

var $ = jQuery;

<span id='Echo-StreamServer-Controls-Stream-Plugins-Reply'>/**
</span> * @class Echo.StreamServer.Controls.Stream.Plugins.Reply
 * Proxies the &quot;Echo.StreamServer.Controls.Stream.Item.Plugins.Reply.onExpand&quot;
 * event on the Stream control level.
 *
 * 	new Echo.StreamServer.Controls.Stream({
 * 		&quot;target&quot;: document.getElementById(&quot;echo-stream&quot;),
 * 		&quot;appkey&quot;: &quot;echo.jssdk.demo.aboutecho.com&quot;,
 * 		&quot;plugins&quot;: [{
 * 			&quot;name&quot;: &quot;Reply&quot;
 * 		}]
 * 	});
 *
 * More information regarding the plugins installation can be found
 * in the [“How to initialize Echo components”](#!/guide/how_to_initialize_components-section-initializing-plugins) guide.
 *
 * @extends Echo.Plugin
 *
 * @private
 * @package streamserver/plugins.pack.js
 * @package streamserver.pack.js
 */
var plugin = Echo.Plugin.manifest(&quot;Reply&quot;, &quot;Echo.StreamServer.Controls.Stream&quot;);

if (Echo.Plugin.isDefined(plugin)) return;

plugin.events = {
	&quot;Echo.StreamServer.Controls.Stream.Item.Plugins.Reply.onExpand&quot;: function(topic, args) {
<span id='Echo-StreamServer-Controls-Stream-Plugins-Reply-echo_event-onFormExpand'>		/**
</span>		 * @echo_event Echo.StreamServer.Controls.Stream.Plugins.Reply.onFormExpand
		 * Triggered if reply form is expanded.
		 */
		this.events.publish({
			&quot;topic&quot;: &quot;onFormExpand&quot;,
			&quot;data&quot;: {
			    &quot;context&quot;: args.context
			}
		});
	}
};

Echo.Plugin.create(plugin);

})(Echo.jQuery);

(function(jQuery) {
&quot;use strict&quot;;

var $ = jQuery;

<span id='Echo-StreamServer-Controls-Submit-Plugins-Reply'>/**
</span> * @class Echo.StreamServer.Controls.Submit.Plugins.Reply
 * Adds internal data field &quot;inReplyTo&quot; for correct reply workflow.
 *
 * 	new Echo.StreamServer.Controls.Submit({
 * 		&quot;target&quot;: document.getElementById(&quot;echo-submit&quot;),
 * 		&quot;appkey&quot;: &quot;echo.jssdk.demo.aboutecho.com&quot;,
 * 		&quot;plugins&quot;: [{
 * 			&quot;name&quot;: &quot;Reply&quot;,
 * 			&quot;inReplyTo&quot;: data 
 * 		}]
 * 	});
 *
 * More information regarding the plugins installation can be found
 * in the [“How to initialize Echo components”](#!/guide/how_to_initialize_components-section-initializing-plugins) guide.
 *
 * @extends Echo.Plugin
 *
 * @private
 * @package streamserver/plugins.pack.js
 * @package streamserver.pack.js
 */
var plugin = Echo.Plugin.manifest(&quot;Reply&quot;, &quot;Echo.StreamServer.Controls.Submit&quot;);

if (Echo.Plugin.isDefined(plugin)) return;

plugin.init = function() {
	var plugin = this, submit = plugin.component;
	var _prepareEventParams = submit._prepareEventParams;
	submit._prepareEventParams = function(params) {
		var _params = _prepareEventParams.call(submit, params);
		_params.inReplyTo = plugin.config.get(&quot;inReplyTo&quot;);
		return _params;
	};
};

<span id='Echo-StreamServer-Controls-Submit-Plugins-Reply-cfg-inReplyTo'>/**
</span> * @cfg {Object} inReplyTo
 * Entry which is the parent for the current reply.
 */

$.map([&quot;onRender&quot;, &quot;onRerender&quot;], function(topic) {
	plugin.events[&quot;Echo.StreamServer.Controls.Submit.&quot; + topic] = function() {
		var submit = this.component;
		submit.config.get(&quot;target&quot;).show();
		submit.view.get(&quot;text&quot;).focus();
	};
});

Echo.Plugin.create(plugin);

})(Echo.jQuery);
</pre>
</body>
</html>
