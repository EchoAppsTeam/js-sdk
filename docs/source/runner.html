<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">(function(jQuery) {
&quot;use strict&quot;;

var $ = jQuery;

if (!window.Echo) window.Echo = {};
if (!Echo.Tests) Echo.Tests = {&quot;Unit&quot;: {}};

// tests will run in the order they were added
QUnit.config.reorder = false;

// don&#39;t execute tests automatically, we will do it manually later
QUnit.config.autostart = false;

QUnit.config.urlConfig.push({
	&quot;id&quot;: &quot;noMockRequests&quot;,
	&quot;label&quot;: &quot;Use real server requests&quot;,
	&quot;tooltip&quot;: &quot;Don&#39;t mock any server requests&quot;
});

// common storage for the information about the current test
// (at the moment only user configuration is stored here)
Echo.Tests.current = {
	&quot;user&quot;: {
		&quot;status&quot;: &quot;anonymous&quot;
	}
};

// logs are pushed here by Echo.Tests.Utils.log function
// (they can be used by the saucelabs or developer/tester)
Echo.Tests.logs = [];

var _initialized = false;
Echo.Tests.init = function(config) {
	if (_initialized) return;
	_initialized = true;
	$(function() {
		$(&quot;#qunit-header&quot;).html(config.title);

		config.backplane &amp;&amp; Backplane.init(config.backplane);

		Echo.Loader.download([{&quot;url&quot;: &quot;tests/qunit/qunit.css&quot;}], function() {
			Echo.Tests.Utils.initServer();
			_runLegacyTests();
			QUnit.start();
		});
	});
};

// TODO: get rid of this function when all tests use new format
function _runLegacyTests() {
	$.each(Echo.Tests.Unit, function(name, suiteClass) {
		$.extend(suiteClass.prototype, new Echo.Tests.Suite());
		suiteClass.prototype.tests = suiteClass.prototype.tests || {};
		var suite = new suiteClass();
		var normalizedName = suite.info.suiteName || suite.normalizeName(name, true);
		// specially mark modules which use the old format of tests
		normalizedName = &quot;[*] &quot; + normalizedName;
		QUnit.module(normalizedName);
		// TODO: register single callback for all test framework
		// (now one callback for each suite so they are called all after each test is finished)
		QUnit.testDone(function(data) {
			if (data.module !== normalizedName) return;
			$.each(suite.info.functions, function(i, name) {
				Echo.Tests.Stats.markFunctionTested(suite.info.className + &quot;.&quot; + name);
			});
		});
		suite.run();
	});
};

(function() {
	var ua = navigator.userAgent.toLowerCase();
	var match = /(chrome)[ \/]([\w.]+)/.exec(ua)
		|| /(webkit)[ \/]([\w.]+)/.exec( ua )
		|| /(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)
		|| /(msie) ([\w.]+)/.exec(ua)
		|| ua.indexOf(&quot;compatible&quot;) &lt; 0 &amp;&amp; /(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)
		|| [];

	var matched = {
		browser: match[1] || &quot;&quot;,
		version: match[2] || &quot;0&quot;
	};
	var browser = {};

	if (matched.browser) {
		browser[matched.browser] = true;
		browser.version = matched.version;
	}

	// Chrome is Webkit, but Webkit is also Safari.
	if (browser.chrome) {
		browser.webkit = true;
	} else if (browser.webkit) {
		browser.safari = true;
	}

	Echo.Tests.browser = browser;
})();

})(Echo.jQuery);
</pre>
</body>
</html>
