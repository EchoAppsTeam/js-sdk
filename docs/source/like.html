<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">(function(jQuery) {
&quot;use strict&quot;;

var $ = jQuery;

<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like'>/**
</span> * @class Echo.StreamServer.Controls.Stream.Item.Plugins.Like
 * Adds extra Like/Unlike buttons to each item in the Echo Stream
 * control for authenticated users.
 *
 * 	new Echo.StreamServer.Controls.Stream({
 * 		&quot;target&quot;: document.getElementById(&quot;echo-stream&quot;),
 * 		&quot;appkey&quot;: &quot;echo.jssdk.demo.aboutecho.com&quot;,
 * 		&quot;plugins&quot;: [{
 * 			&quot;name&quot;: &quot;Like&quot;
 * 		}]
 * 	});
 *
 * More information regarding the plugins installation can be found
 * in the [“How to initialize Echo components”](#!/guide/how_to_initialize_components-section-2) guide.
 *
 * @extends Echo.Plugin
 *
 * @package streamserver/plugins.pack.js
 * @package streamserver.pack.js
 */
var plugin = Echo.Plugin.manifest(&quot;Like&quot;, &quot;Echo.StreamServer.Controls.Stream.Item&quot;);

if (Echo.Plugin.isDefined(plugin)) return;

plugin.init = function() {
	this.extendTemplate(&quot;insertAsLastChild&quot;, &quot;data&quot;, plugin.template);
	this.component.addButtonSpec(&quot;Like&quot;, this._assembleButton(&quot;Like&quot;));
	this.component.addButtonSpec(&quot;Like&quot;, this._assembleButton(&quot;Unlike&quot;));
};

plugin.config = {
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-cfg-asyncFacePileRendering'>	/**
</span>	 * @cfg {Boolean} asyncFacePileRendering
	 * This parameter is used to enable FacePile control rendering in async mode.
	 */
	&quot;asyncFacePileRendering&quot;: false
};

plugin.labels = {
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_label-likeThis'>	/**
</span>	 * @echo_label
	 */
	&quot;likeThis&quot;: &quot; like this.&quot;,
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_label-likesThis'>	/**
</span>	 * @echo_label
	 */
	&quot;likesThis&quot;: &quot; likes this.&quot;,
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_label-likeControl'>	/**
</span>	 * @echo_label
	 */
	&quot;likeControl&quot;: &quot;Like&quot;,
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_label-unlikeControl'>	/**
</span>	 * @echo_label
	 */
	&quot;unlikeControl&quot;: &quot;Unlike&quot;,
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_label-likeProcessing'>	/**
</span>	 * @echo_label
	 */
	&quot;likeProcessing&quot;: &quot;Liking...&quot;,
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_label-unlikeProcessing'>	/**
</span>	 * @echo_label
	 */
	&quot;unlikeProcessing&quot;: &quot;Unliking...&quot;
};

plugin.dependencies = [{
	&quot;control&quot;: &quot;Echo.StreamServer.Controls.FacePile&quot;,
	&quot;url&quot;: &quot;{config:cdnBaseURL.sdk}/streamserver.pack.js&quot;
}];

plugin.events = {
	&quot;Echo.StreamServer.Controls.FacePile.Item.Plugins.Like.onUnlike&quot;: function(topic, args) {
		this._sendActivity(&quot;Unlike&quot;, this.component, args.actor);
		return {&quot;stop&quot;: [&quot;bubble&quot;]};
	}
};

plugin.template = '&lt;div class=&quot;{plugin.class:likedBy}&quot;&gt;&lt;/div&gt;';

<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_renderer-likedBy'>/**
</span> * @echo_renderer
 */
plugin.renderers.likedBy = function(element) {
	var plugin = this;
	var item = this.component;
	if (!item.get(&quot;data.object.likes&quot;).length) {
		return element.hide();
	}
	var likesPerPage = 5;
	var visibleUsersCount = plugin.get(&quot;facePile&quot;)
		? plugin.get(&quot;facePile&quot;).getVisibleUsersCount()
		: likesPerPage;
	var youLike = false;
	var userId = item.user.get(&quot;identityUrl&quot;);
	var users = item.get(&quot;data.object.likes&quot;);
	$.each(users, function(i, like) {
		if (like.actor.id === userId) {
			youLike = true;
			return false; // break
		}
	});
	var config = plugin.config.assemble({
		&quot;target&quot;: element.get(0),
		&quot;data&quot;: {
			&quot;itemsPerPage&quot;: likesPerPage,
			&quot;entries&quot;: users
		},
		&quot;initialUsersCount&quot;: visibleUsersCount,
		&quot;totalUsersCount&quot;: item.get(&quot;data.object.accumulators.likesCount&quot;),
		&quot;suffixText&quot;: plugin.labels.get(users.length &gt; 1 || youLike ? &quot;likeThis&quot; : &quot;likesThis&quot;)
	});
	config.plugins.push({&quot;name&quot;: &quot;Like&quot;});
	if (item.user.is(&quot;admin&quot;)) {
		element.addClass(plugin.cssPrefix + &quot;highlight&quot;);
	}
	if (this.config.get(&quot;asyncFacePileRendering&quot;)) {
		setTimeout($.proxy(this._initFacePile, this, config), 0);
	} else {
		this._initFacePile(config);
	}
	return element.show();
};

plugin.methods._initFacePile = function(config) {
	this.set(&quot;facePile&quot;, new Echo.StreamServer.Controls.FacePile(config));
};

plugin.methods._sendRequest = function(data, callback, errorCallback) {
	Echo.StreamServer.API.request({
		&quot;endpoint&quot;: &quot;submit&quot;,
		&quot;secure&quot;: this.config.get(&quot;useSecureAPI&quot;, false, true),
		&quot;submissionProxyURL&quot;: this.component.config.get(&quot;submissionProxyURL&quot;),
		&quot;onData&quot;: callback,
		&quot;onError&quot;: errorCallback,
		&quot;data&quot;: data
	}).send();
};

plugin.methods._sendActivity = function(name, item, actor) {
	var plugin = this;
	var activity = {
		&quot;verbs&quot;: [&quot;http://activitystrea.ms/schema/1.0/&quot; + name.toLowerCase()],
		&quot;targets&quot;: [{&quot;id&quot;: item.get(&quot;data.object.id&quot;)}]
	};
	if (actor &amp;&amp; actor.id) {
		activity.author = actor.id;
	}

	this._sendRequest({
		&quot;content&quot;: activity,
		&quot;appkey&quot;: item.config.get(&quot;appkey&quot;),
		&quot;sessionID&quot;: item.user.get(&quot;sessionID&quot;),
		&quot;target-query&quot;: item.config.get(&quot;parent.query&quot;)
	}, function(response) {
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_event-onLikeComplete'>		/**
</span>		 * @echo_event Echo.StreamServer.Controls.Stream.Item.Plugins.Like.onLikeComplete
		 * Triggered when the Like operation is finished.
		 */
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_event-onUnlikeComplete'>		/**
</span>		 * @echo_event Echo.StreamServer.Controls.Stream.Item.Plugins.Like.onUnlikeComplete
		 * Triggered when the reverse Like operation is finished.
		 */
		plugin._publishEventComplete({
			&quot;name&quot;: name,
			&quot;state&quot;: &quot;Complete&quot;,
			&quot;response&quot;: response
		});
		plugin.requestDataRefresh();
	}, function(response) {
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_event-onLikeError'>		/**
</span>		 * @echo_event Echo.StreamServer.Controls.Stream.Item.Plugins.Like.onLikeError
		 * Triggered when the Like operation failed.
		 */
<span id='Echo-StreamServer-Controls-Stream-Item-Plugins-Like-echo_event-onUnlikeError'>		/**
</span>		 * @echo_event Echo.StreamServer.Controls.Stream.Item.Plugins.Like.onUnlikeError
		 * Triggered when the reverse Like operation failed.
		 */
		plugin._publishEventComplete({
			&quot;name&quot;: name,
			&quot;state&quot;: &quot;Error&quot;,
			&quot;response&quot;: response
		});
	});
};

plugin.methods._publishEventComplete = function(args) {
	var item = this.component;
	this.events.publish({
		&quot;topic&quot;: &quot;on&quot; + args.name + args.state,
		&quot;data&quot;: {
			&quot;item&quot;: {
				&quot;data&quot;: item.get(&quot;data&quot;),
				&quot;target&quot;: item.config.get(&quot;target&quot;)
			},
			&quot;response&quot;: args.response
		}
	});
};

plugin.methods._assembleButton = function(name) {
	var plugin = this;
	var callback = function() {
		var item = this;
		item.get(&quot;buttons.&quot; + plugin.name + &quot;.&quot; + name + &quot;.element&quot;)
			.empty()
			.append(plugin.labels.get(name.toLowerCase() + &quot;Processing&quot;));
		plugin._sendActivity(name, item);
	};
	return function() {
		var item = this;
		var action =
			($.map(item.get(&quot;data.object.likes&quot;), function(entry) {
				if (item.user.has(&quot;identity&quot;, entry.actor.id)) return entry;
			})).length &gt; 0 ? &quot;Unlike&quot; : &quot;Like&quot;;
		return {
			&quot;name&quot;: name,
			&quot;label&quot;: plugin.labels.get(name.toLowerCase() + &quot;Control&quot;),
			&quot;visible&quot;: item.user.is(&quot;logged&quot;) &amp;&amp; action === name,
			&quot;once&quot;: true,
			&quot;callback&quot;: callback
		};
	};
};

plugin.css =
	'.{plugin.class:likedBy} { background: url({config:cdnBaseURL.sdk-assets}/images/likes.png) no-repeat 0px 4px; padding: 0px 0px 4px 21px; }' +
	'.{plugin.class:highlight} { line-height: 23px; }';

Echo.Plugin.create(plugin);

})(Echo.jQuery);

(function(jQuery) {
&quot;use strict&quot;;

var $ = jQuery;

<span id='Echo-StreamServer-Controls-FacePile-Item-Plugins-Like'>/**
</span> * @class Echo.StreamServer.Controls.FacePile.Item.Plugins.Like
 * Adds extra controls to items in the Echo FacePile control.
 *
 * @extends Echo.Plugin
 * @private
 */
var plugin = Echo.Plugin.manifest(&quot;Like&quot;, &quot;Echo.StreamServer.Controls.FacePile.Item&quot;);

if (Echo.Plugin.isDefined(plugin)) return;

plugin.init = function() {
	this.extendTemplate(&quot;insertAsLastChild&quot;, &quot;container&quot;, plugin.template);
};

plugin.labels = {
<span id='Echo-StreamServer-Controls-FacePile-Item-Plugins-Like-echo_label-unlikeOnBehalf'>	/**
</span>	 * @echo_label
	 */
	&quot;unlikeOnBehalf&quot;: &quot;Unlike on behalf of this user&quot;
};

plugin.template = '&lt;img class=&quot;{plugin.class:adminUnlike}&quot; src=&quot;{config:cdnBaseURL.sdk-assets}/images/container/closeWindow.png&quot;&quot; title=&quot;{plugin.label:unlikeOnBehalf}&quot; width=&quot;10&quot; height=&quot;9&quot;&gt;';

<span id='Echo-StreamServer-Controls-FacePile-Item-Plugins-Like-echo_renderer-container'>/**
</span> * @echo_renderer
 */
plugin.component.renderers.container = function(element) {
	this.parentRenderer(&quot;container&quot;, arguments);
	if (this.component.user.is(&quot;admin&quot;)) {
		element.addClass(this.cssPrefix + &quot;highlight&quot;);
	}
};

<span id='Echo-StreamServer-Controls-FacePile-Item-Plugins-Like-echo_renderer-adminUnlike'>/**
</span> * @echo_renderer
 */
plugin.renderers.adminUnlike = function(element) {
	var plugin = this;
	var item = this.component;
	if (!item.user.is(&quot;admin&quot;)) {
		return element.remove();
	}
	return element.one(&quot;click&quot;, function() {
		item.view.get(&quot;container&quot;).css(&quot;opacity&quot;, 0.3);
<span id='Echo-StreamServer-Controls-FacePile-Item-Plugins-Like-echo_event-onUnlike'>		/**
</span>		 * @echo_event Echo.StreamServer.Controls.FacePile.Item.Plugins.Like.onUnlike
		 * Triggered when the item is &quot;unliked&quot; by admin on behalf of a user.
		 */
		plugin.events.publish({
			&quot;topic&quot;: &quot;onUnlike&quot;,
			&quot;data&quot;: {
				&quot;actor&quot;: item.get(&quot;data&quot;),
				&quot;target&quot;: item.config.get(&quot;parent.target&quot;).get(0)
			},
			&quot;global&quot;: false,
			&quot;propagation&quot;: false
		});
	});
};

plugin.css =
	'.{plugin.class:adminUnlike} { cursor: pointer; margin-left: 3px; }' +
	'.{plugin.class:highlight} { display: inline-block; line-height: 16px; background-color: #EEEEEE; padding: 1px 3px; border: 1px solid #D2D2D2; border-radius: 5px; -moz-border-radius: 5px; -webkit-border-radius: 5px; margin: 0px 2px; }';

Echo.Plugin.create(plugin);

})(Echo.jQuery);
</pre>
</body>
</html>
